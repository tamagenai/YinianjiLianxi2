<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>中国語クイズ</title>
  <style>
    .header {
      position: fixed;
      top: 0px;
      left: 0px;
      z-index: 10;
      background-color: lemonchiffon;
      width: 100%;


    }
    .header p {
      padding-left: 100px;
     
    }



    .clkBtn {
      cursor: pointer;
      user-select: none;
    }

    .divFlex {
      display: flex;
      padding-left: 20px;
    }

    .sheetSelect {
      padding-top: 0px;
    }

    .speed {
      padding-top: 0px;
    }

    .dataContent {
      padding-top: 120px;

      display: block;
    }

    .dataDisplay {
      display: block;
    }

    .dataNone {
      display: none;
    }

    .member {
      margin-bottom: 20px;
    }

    .member span {

      border: 1px solid pink;
      border-radius: 10%;
      display: inline-block;
      margin-right: 10px;
    }

    .hanyuDisplay {
      display: block;
      font-weight: bold;
    }

    .hanyuNoDisplay {
      display: none;
    }

    .pinyin {
      display: block;
      font-weight: bold;
    }

    .pinyinDisplay {
      display: block;
      font-weight: bold;
    }

    .pinyinNoDisplay {
      display: none;
    }

    .japaneseDisplay {
      display: block;
    }

    .japaneseNoDisplay {
      display: none;
    }

    .inputNoDisplay {
      display: none;
    }

    #check-next {
      background-color: cyan;
      border-radius: 20%;
      width: 100px;
      height: 40px;
      text-align: center;
      line-height: 40px;
      cursor: pointer;
      user-select: none;
      margin-left: 40px;
    }

    .divSpeak {
      background-color: cyan;
      border-radius: 20%;
      width: 100px;
      height: 40px;
      text-align: center;
      line-height: 40px;
      margin-bottom: 20px;
      cursor: pointer;
      user-select: none;

    }
  </style>
</head>

<body>
  <div class="header">
    <p>中国語クイズ</p>

    <div class="divFlex">
      <div class="sheetSelect">

        <label for="sheet-select">シート選択：</label><select id="sheet-select" name="sheetSelect"></select>
      </div>
      <div class="speed">
        <label for="speech-Speed">　　音声スピード:</label>

        <select name="speechSpeed" id="speech-Speed">
          <option value="1.0">1.0</option>
          <option value="0.9">0.9</option>
          <option value="0.8">0.8</option>
          <option value="0.7">0.7</option>
          <option value="0.6">0.6</option>
          <option value="0.5">0.5</option>
          <option value="1.1">1.1</option>
          <option value="1.2">1.2</option>
          <option value="1.3">1.3</option>
          <option value="1.4">1.4</option>
          <option value="1.5">1.5</option>
          <option value="1.6">1.6</option>
          <option value="1.7">1.7</option>
          <option value="1.8">1.8</option>
          <option value="1.9">1.9</option>
          <option value="2.0">2.0</option>

        </select>
      </div>
    </div>
  </div>
  <div id="main">
    <div id="container">

    </div>
    

  </div>
  <!-- <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script> -->
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>

    /*!
 * jQuery UI Touch Punch 0.2.3
 *
 * Copyright 2011–2014, Dave Furfero
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Depends:
 *  jquery.ui.widget.js
 *  jquery.ui.mouse.js
 */
    !function (a) { function f(a, b) { if (!(a.originalEvent.touches.length > 1)) { a.preventDefault(); var c = a.originalEvent.changedTouches[0], d = document.createEvent("MouseEvents"); d.initMouseEvent(b, !0, !0, window, 1, c.screenX, c.screenY, c.clientX, c.clientY, !1, !1, !1, !1, 0, null), a.target.dispatchEvent(d) } } if (a.support.touch = "ontouchend" in document, a.support.touch) { var e, b = a.ui.mouse.prototype, c = b._mouseInit, d = b._mouseDestroy; b._touchStart = function (a) { var b = this; !e && b._mouseCapture(a.originalEvent.changedTouches[0]) && (e = !0, b._touchMoved = !1, f(a, "mouseover"), f(a, "mousemove"), f(a, "mousedown")) }, b._touchMove = function (a) { e && (this._touchMoved = !0, f(a, "mousemove")) }, b._touchEnd = function (a) { e && (f(a, "mouseup"), f(a, "mouseout"), this._touchMoved || f(a, "click"), e = !1) }, b._mouseInit = function () { var b = this; b.element.bind({ touchstart: a.proxy(b, "_touchStart"), touchmove: a.proxy(b, "_touchMove"), touchend: a.proxy(b, "_touchEnd") }), c.call(b) }, b._mouseDestroy = function () { var b = this; b.element.unbind({ touchstart: a.proxy(b, "_touchStart"), touchmove: a.proxy(b, "_touchMove"), touchend: a.proxy(b, "_touchEnd") }), d.call(b) } } }(jQuery);

  </script>
  <script>
    $(function () {
      $('.connectedSortable').sortable({
        // このクラス間だけ相互移動できる。
        connectWith: '.connectedSortable',
      }).disableSelection();
    });
  </script>



  <!-- <script src="./get_post_gss.js"></script> -->
  <script>
    let cssIndex = 0;

    let swButton = false;  // false: check  true: next

    let main;
    let container;
    let checknext;
    let comment;
    main = document.getElementById('main');
    container = document.getElementById('container');
    // document.addEventListener('DOMContentLoaded', function () {
    var tdOLD;//2023/08/24 追加
    let questions;
    function speakData(param1, param2) {

      // if (param1 instanceof HTMLTableCellElement) {
      const td = param1;

      var uttr = new SpeechSynthesisUtterance(td.textContent);
      uttr.lang = "zh-CN"
      uttr.rate = speakSpeedRate();
      speechSynthesis.cancel();
      speechSynthesis.speak(uttr);

      // }

    }
    function speakDataX(param1, param2) {


      const td = param1;
      let answerGroup = document.querySelectorAll('.answer');;
      let questionGroup = document.querySelectorAll('.question');;
      let answerSpans = answerGroup[cssIndex];
      let questionSpans = questionGroup[cssIndex];
      let sheetDatas;

      var uttr = new SpeechSynthesisUtterance(td.textContent);
      uttr.lang = "zh-CN"
      uttr.rate = speakSpeedRate();
      speechSynthesis.cancel();
      speechSynthesis.speak(uttr);
      if (param1.parentElement.classList.contains('answer')) {
        questionSpans.appendChild(param1);



      } else {
        answerSpans.appendChild(param1);


      }



    }
    function speakData2() {
      let l = 1;
      // if (param1 instanceof HTMLTableCellElement) {
      const hanyuWords = questions[cssIndex][1];
      var uttr = new SpeechSynthesisUtterance(hanyuWords);
      uttr.lang = "zh-CN"
      uttr.rate = speakSpeedRate();
      speechSynthesis.cancel();
      speechSynthesis.speak(uttr);

      // }

    }

    // speak speed 調整 2023-06-22
    function speakSpeedRate() {

      let select = document.querySelector('[name="speechSpeed"]');

      var rate = parseFloat(select.selectedOptions[0].value);
      return rate;

    }
    // window.onload = function () {

    const END_POINT = "https://script.google.com/macros/s/AKfycbx-Y7FoyAOijqncw46cGxluI_apkjuiDuxrPkzG0l4n7l--pblmSjEnHtoirvJGW4wS/exec";
    //スプレッドシート（タブ）の番号

    // 2023-07-03 ファーウェイスマホ対応変更

    // 23-06-13 -五十音が変更されたときに実行される。----------------------

    let select = document.querySelector('[name="sheetSelect"]');

    select.onchange = event => {
      var selIndex = select.selectedIndex;
      sheetIndex = selIndex;
      console.log(select.selectedIndex);



      container.remove();
      container = document.createElement('div');
      container.setAttribute('id', 'container');
      main.appendChild(container);
      questions = sheetDatas[selIndex + 1];
      renderQuestions(questions);
      iniCSSSet();
      cssIndex = 0;
      swButton = false;
    }


   

    const sheetSelector = document.getElementById("sheet-select");

    // const wrapper = document.getElementById("wrapper");




    getFromGAS();//起動時のデータ取得

    //----------- 以下、関数定義--------------------------

    function getFromGAS() {

      $.ajax({
        type: "GET",
        url: END_POINT,
        // data: { sheetNo: SHEET_NO }

      }).done((result) => {        // 成功した時の処理
        console.log("get done:" + result);
        setSheetNames(JSON.parse(result)[0]);

        // getFromGAS(1);
        sheetDatas = JSON.parse(result);
        questions = sheetDatas[1];
        renderQuestions(questions);

        iniCSSSet();
      }).fail((error) => {  // 失敗した時の処理
        alert('Error:' + JSON.stringify(error));

      }).always((data) => {// 常にやる処理
        // do something
        // enableControlElements();
      });
    }


    function setSheetNames(sheetNamesArray) {
      sheetSelector.innerHTML = "";
      document.createElement('option')
      sheetNamesArray.forEach((sheetName, index) => {
        let option = document.createElement('option');
        option.setAttribute('value', index + 1);
        option.innerHTML = sheetName;
        sheetSelector.appendChild(option);
      });
    }
    function renderQuestions(questions) {
      questions.forEach((question) => {
        if (question[0] === 'A') {
          renderA_Question(question);
        } else if (question[0] === 'B') {
          renderB_Question(question);
        } else if (question[0] === 'C') {
          renderC_Question(question);


        } else if (question[0] === 'D') {
          renderD_Question(question);

        }



      });
      
      comment = document.createElement('p');
      comment.setAttribute('id', 'comment');
      container.appendChild(comment);
      checknext = document.createElement('div');
      checknext.setAttribute('id', 'check-next');
      checknext.setAttribute('onclick', 'checkNext()');
      checknext.textContent = 'チェック';
      container.appendChild(checknext);
      

    }






    function renderA_Question(question) {
      // const container = document.getElementById('main');
      container = document.getElementById('container');
      let div, p, span, divContent;
      divContent = document.createElement('dir');
      divContent.setAttribute('class', 'dataContent');
      container.appendChild(divContent);
      //
      div = document.createElement('div');

      div.setAttribute('class', 'input inputNodisplay');
      divContent.appendChild(div);
      //
      p = document.createElement('p');
      p.textContent = question[2];
      p.setAttribute('class', 'pinyin pinyinNoDisplay');
      divContent.appendChild(p);
      //
      p = document.createElement('p');
      p.textContent = question[1];
      p.setAttribute('class', 'hanyu hanyuNoDisplay');
      p.setAttribute('onclick', 'speakData(this)');
      divContent.appendChild(p);
      //
      p = document.createElement('p');
      p.textContent = question[3];
      p.setAttribute('class', 'japanese');
      divContent.appendChild(p);
      // 
      div = document.createElement('div');
      div.setAttribute('class', 'answer member connectedSortable');
      divContent.appendChild(div);
      span = document.createElement('span');
      span.textContent = '回答：　';
      div.appendChild(span);
      // 
      div = document.createElement('div');
      div.setAttribute('class', 'question member connectedSortable');
      divContent.appendChild(div);
      span = document.createElement('span');
      span.textContent = '問題：　';
      div.appendChild(span);
      let i;
      for (i = 4; i < question.length; i++) {
        if (question[i] !== '') {
          span = document.createElement('span');
          span.textContent = question[i];
          span.setAttribute('onclick', 'speakDataX(this)')
          span.setAttribute('onmousedown', 'speakData(this)')
          div.appendChild(span);

        }

      }


    }
    function renderB_Question(question) {
      // const container = document.getElementById('container');
      container = document.getElementById('container');
      let div, p, span, divContent, button;
      divContent = document.createElement('dir');
      divContent.setAttribute('class', 'dataContent');
      container.appendChild(divContent);
      //
      //
      div = document.createElement('div');

      div.setAttribute('class', 'input inputNodisplay');
      divContent.appendChild(div);
      //
      p = document.createElement('p');
      p.textContent = question[2];
      p.setAttribute('class', 'pinyin pinyinNoDisplay');

      divContent.appendChild(p);
      //
      p = document.createElement('p');
      p.textContent = question[1];
      p.setAttribute('class', 'hanyu hanyuNoDisplay');
      p.setAttribute('onclick', 'speakData(this)');
      divContent.appendChild(p);
      //
      p = document.createElement('p');
      p.textContent = question[3];
      p.setAttribute('class', 'japanese japaneseNoDisplay');
      divContent.appendChild(p);
      //
      divSpeak = document.createElement('div');
      divSpeak.textContent = 'Speak';
      divSpeak.setAttribute('onclick', 'speakData2()');
      divSpeak.setAttribute('class', 'divSpeak');
      divContent.appendChild(divSpeak);
      //
      div = document.createElement('div');
      div.setAttribute('class', 'answer member connectedSortable');
      divContent.appendChild(div);
      span = document.createElement('span');
      span.textContent = '回答：　';
      div.appendChild(span);
      // 
      div = document.createElement('div');
      div.setAttribute('class', 'question member connectedSortable');
      divContent.appendChild(div);
      span = document.createElement('span');
      span.textContent = '問題：　';
      div.appendChild(span);
      let i;
      for (i = 4; i < question.length; i++) {
        if (question[i] !== '') {
          span = document.createElement('span');
          span.textContent = question[i];
          span.setAttribute('onclick', 'speakDataX(this)')
          span.setAttribute('onmousedown', 'speakData(this)')
          div.appendChild(span);

        }

      }

    }
    // 
    function renderC_Question(question) {
      // const container = document.getElementById('container');
      container = document.getElementById('container');
      let div, p, span, divContent, input;
      divContent = document.createElement('dir');
      divContent.setAttribute('class', 'dataContent');
      container.appendChild(divContent);
      //

      p = document.createElement('p');
      p.textContent = question[2];
      p.setAttribute('class', 'pinyin pinyinNoDisplay');
      divContent.appendChild(p);
      //
      p = document.createElement('p');
      p.textContent = question[1];
      p.setAttribute('class', 'hanyu hanyuNoDisplay');
      p.setAttribute('onclick', 'speakData(this)');
      divContent.appendChild(p);
      //
      //
      p = document.createElement('p');
      p.textContent = question[3];
      p.setAttribute('class', 'japanese japaneseNoDisplay');

      divContent.appendChild(p);
      //
      p = document.createElement('p');
      p.textContent = 'ピンインを漢字に直して並べ替え正しい文章にしてください。';

      divContent.appendChild(p);

      // 
      // 
      div = document.createElement('div');
      div.setAttribute('class', 'answer member connectedSortable');
      divContent.appendChild(div);
      span = document.createElement('span');
      span.textContent = '';
      div.appendChild(span);
      //
      div = document.createElement('div');
      div.setAttribute('class', 'question member connectedSortable');
      divContent.appendChild(div);
      span = document.createElement('span');
      span.textContent = '問題：　';
      div.appendChild(span);
      let i;
      for (i = 4; i < question.length; i++) {
        if (question[i] !== '') {
          span = document.createElement('span');
          span.textContent = question[i];
  
          div.appendChild(span);

        }

      }
      // 
      div = document.createElement('div');
      div.textContent = '中国語入力';
      divContent.appendChild(div);
      input = document.createElement('input');

      input.setAttribute('class', 'input');
      input.setAttribute('maxlength', '40');
      input.setAttribute('size', '40');
      div.appendChild(input);

    }
    function renderD_Question(question) {
      // const container = document.getElementById('container');
      container = document.getElementById('container');
      let div, p, span, divContent;
      divContent = document.createElement('dir');
      divContent.setAttribute('class', 'dataContent');
      container.appendChild(divContent);
      //
      div = document.createElement('div');

      div.setAttribute('class', 'input inputNodisplay');
      divContent.appendChild(div);
      //
      p = document.createElement('p');
      p.textContent = question[2];
      p.setAttribute('class', 'pinyin');
      divContent.appendChild(p);
      //
      p = document.createElement('p');
      p.textContent = question[1];
      p.setAttribute('class', 'hanyu hanyuNoDisplay');
      p.setAttribute('onclick', 'speakData(this)');
      divContent.appendChild(p);
      //
      p = document.createElement('p');
      p.textContent = question[3];
      p.setAttribute('class', 'japanese japaneseNoDisplay');
      divContent.appendChild(p);
      // 
      div = document.createElement('div');
      div.setAttribute('class', 'answer member connectedSortable');
      divContent.appendChild(div);
      span = document.createElement('span');
      span.textContent = '回答：　';
      div.appendChild(span);
      // 
      div = document.createElement('div');
      div.setAttribute('class', 'question member connectedSortable');
      divContent.appendChild(div);
      span = document.createElement('span');
      span.textContent = '問題：　';
      div.appendChild(span);
      let i;
      for (i = 4; i < question.length; i++) {
        if (question[i] !== '') {
          span = document.createElement('span');
          span.textContent = question[i];
          span.setAttribute('onclick', 'speakDataX(this)')
          span.setAttribute('onmousedown', 'speakData(this)')
          div.appendChild(span);

        }

      }


    }
    //

    function checkNext() {
      if (swButton) {
        swButton = false;
        checknext.textContent = 'チェック';
        const hanyuGroup = document.querySelectorAll('.hanyu');
        const pinyinGroup = document.querySelectorAll('.pinyin');
        const japaneseGroup = document.querySelectorAll('.japanese');
        //
        const comment = document.getElementById('comment');
        comment.textContent = "";
        var classElement = document.getElementsByClassName('dataContent');
        cssIndex++;
        if (cssIndex === classElement.length) {
          cssIndex = 0;
        }

        for (let i = 0; i < classElement.length; i++) {
          if (i === cssIndex) {
            classElement[i].classList.add("dataDisplay");
            classElement[i].classList.remove("dataNone");

          } else {
            classElement[i].classList.add("dataNone");
            classElement[i].classList.remove("dataDisplay");

          }
          if (hanyuGroup[i].classList.contains('hanyuDisplay')) {
            hanyuGroup[i].classList.remove('hanyuDisplay');
            hanyuGroup[i].classList.add('hanyuNoDisplay');
          }
          if (pinyinGroup[i].classList.contains('pinyinDisplay')) {
            pinyinGroup[i].classList.remove('pinyinDisplay');
            pinyinGroup[i].classList.add('pinyinNoDisplay');
          }
          if (japaneseGroup[i].classList.contains('japaneseDisplay')) {
            japaneseGroup[i].classList.remove('japaneseDisplay');
            japaneseGroup[i].classList.add('japaneseNoDisplay');
          }

        }

      } else {
        swButton = true;
        checknext.textContent = '次の問題';
        const comment = document.getElementById('comment');
        const hanyuGroup = document.querySelectorAll('.hanyu');
        const pinyinGroup = document.querySelectorAll('.pinyin');
        hanyuGroup[cssIndex].classList.add('hanyuDisplay');
        hanyuGroup[cssIndex].classList.remove('hanyuNoDisplay');
        if (questions[cssIndex][0] !== 'D') {
          pinyinGroup[cssIndex].classList.add('pinyinDisplay');
          pinyinGroup[cssIndex].classList.remove('pinyinNoDisplay');

        }
        const hanyu = questions[cssIndex][1];
        const pinyin = questions[cssIndex][2];
        console.log(hanyu);
        //
        if (questions[cssIndex][0] !== 'A') {
          const japaneseGroup = document.querySelectorAll('.japanese');
          japaneseGroup[cssIndex].classList.add('japaneseDisplay');
          japaneseGroup[cssIndex].classList.remove('japaneseNoDisplay');

        }
        if (questions[cssIndex][0] === 'C') {
          const inputGroup = document.querySelectorAll('.input');
          let inputHanyu = inputGroup[cssIndex];
          if (inputHanyu.value === hanyu) {
            comment.textContent = '大変よくできました。';
          } else {
            comment.textContent = '間違っています！　もっとしっかり勉強して。';

          }

        } else {
          const answers = document.querySelectorAll('.answer');

          span = answers[cssIndex].getElementsByTagName('span');

          let answerString = '';
          let i;
          for (i = 1; i < span.length; i++) {
            answerString = answerString + span[i].textContent;

          }
          console.log(answerString);


          if (answerString === hanyu) {

            comment.textContent = '大変よくできました。';
            console.log('OK');
          } else {
            comment.textContent = '間違っています！　もっとしっかり勉強して。';
            console.log('wrong');
          }

        }
        //
      }

    }
    // const checknext = document.getElementById('check-next');
    // checknext.addEventListener('click', () => {







    // iniCSSSet();




    // 23-06-13 ------------------------------------------------------





    // イニシャル　書くシート用のCSS セット　　最初の問題に移る
    function iniCSSSet() {
      cssIndex = 0;
      var classElement = document.getElementsByClassName('dataContent');
      classElement[0].classList.add("dataDisplay");
      for (let i = 1; i < classElement.length; i++) {
        classElement[i].classList.add("dataNone");
      }

    }
    
  </script>
</body>

</html>